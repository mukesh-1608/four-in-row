<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Connect 4 Logic Test</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        #log { border: 1px solid #ccc; padding: 10px; height: 150px; overflow-y: scroll; background: #f0f0f0; margin-top: 20px; }
        .board { display: grid; grid-template-columns: repeat(7, 50px); gap: 5px; background: #00f; padding: 10px; width: fit-content; }
        .cell { width: 50px; height: 50px; background: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .p1 { background: #f00; }
        .p2 { background: #ff0; }
        .controls { margin-bottom: 20px; }
    </style>
</head>
<body>
    <h1>Connect 4 Logic Test (Step 2)</h1>
    <div class="controls">
        <button onclick="connect()">Connect</button>
        <span id="status">Disconnected</span>
        <span id="turn"></span>
    </div>

    <div id="board" class="board">
        <!-- Cells generated by JS -->
    </div>

    <div id="log"></div>

    <script>
        let ws;
        const boardEl = document.getElementById('board');

        // Init board UI
        for (let r = 0; r < 6; r++) {
            for (let c = 0; c < 7; c++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.dataset.col = c;
                cell.onclick = () => sendMove(c);
                boardEl.appendChild(cell);
            }
        }

        function log(msg) {
            const div = document.getElementById('log');
            div.innerHTML += `<div>${new Date().toLocaleTimeString()} - ${msg}</div>`;
            div.scrollTop = div.scrollHeight;
        }

        function connect() {
            if (ws) return;
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                document.getElementById('status').innerText = "Connected";
                log("Connected");
            };
            
            ws.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                log("Rx: " + msg.type);
                
                if (msg.type === 'update') {
                    renderBoard(msg.payload.board);
                    document.getElementById('turn').innerText = "Turn: " + msg.payload.currentTurn;
                    if (msg.payload.status === 'finished') {
                        alert("Game Over! Winner: " + msg.payload.winner);
                    }
                } else if (msg.type === 'error') {
                    alert("Error: " + msg.payload);
                } else if (msg.type === 'game_over') {
                     alert("Game Over! Winner: " + msg.payload.winner);
                }
            };
            
            ws.onerror = (err) => log("Error: " + err);
        }

        function sendMove(col) {
            if (!ws) return;
            const msg = {
                type: 'move',
                payload: { column: parseInt(col) }
            };
            ws.send(JSON.stringify(msg));
        }

        function renderBoard(grid) {
            const cells = document.querySelectorAll('.cell');
            cells.forEach(c => c.className = 'cell'); // reset
            
            for (let r = 0; r < 6; r++) {
                for (let c = 0; c < 7; c++) {
                    const val = grid[r][c];
                    const idx = r * 7 + c;
                    if (val === 1) cells[idx].classList.add('p1');
                    if (val === 2) cells[idx].classList.add('p2');
                }
            }
        }
    </script>
</body>
</html>
